<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-10-19 Tue 21:41 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>mDNS, avahi and docker non-root containers</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Gnanesh Kunal">
<meta name="description" content="Run mDNS on docker non-root containers."
>
<meta name="keywords" content="Networking, DNS, Avahi">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="css/stylesheet.css">
<link rel="stylesheet" media="screen" href="https://fontlibrary.org//face/source-sans-pro" type="text/css"/><link rel="stylesheet" media="screen" href="https://fontlibrary.org//face/source-code-pro" type="text/css"/><script data-goatcounter="https://gnanesh.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">mDNS, avahi and docker non-root containers</h1>
</header><p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-05-30 Sat&gt;</span></span>
</p>

<p>
IP addresses are hard to remember and that's why we have DNS. But
still, on most of the local systems, we don't have a DNS server and we
have to remember the IP addresses of the systems. Even worse, let me
say I have a cluster with 1000 nodes. Without a <a href="https://en.wikipedia.org/wiki/Name_server">nameserver</a> or
auto-discovery tool, I should remember all the IP addresses of the
cluster nodes.
</p>

<p>
One thing the modern cluster architecture supports is node
discovery. Now, you have the same cluster with 1000 nodes, you don't
have to remember all the nodes IP addresses but just one node and that
one node also acts as a service discovery to other nodes. For example,
if your application wants to talk to <code>node4</code> and you know only
<code>node1</code>'s IP address, you can either talk to <code>node1</code> as if you are
talking to <code>node4</code> which <code>node1</code> redirects the communication to
<code>node4</code> or you can ask <code>node1</code> for <code>node4</code>'s IP address.
</p>

<p>
But one major problem is that if <code>node1</code> goes down for some reason,
even though the cluster will still be working with the rest of the 999
nodes or one new node with different IP address gets added up, you
lose the access to the entire cluster because all you have got is
<code>node1</code>'s IP address and <code>node1</code> is currently not in the cluster. For
this reason, we have a cluster IP address. What exists at the core of
the cluster system is a node discovery service. Your application
connects to the cluster IP, and you don't have to worry about some
nodes being down since the cluster IP is nowhere related to it and
only acts as a discovery tool for the nodes and other services in the
cluster.
</p>

<p>
And now, we are at it again. We now have to remember the IP address of
the cluster. If it is IPv6, it's nearly impossible to remember the
address. The cluster system lacks a human-readable name, i.e., it
lacks a name server. If the cluster exists in a cloud system, you
don't have to worry about remembering since the external DNS comes
into the picture and you can set up a domain name.
</p>

<p>
Most of the local systems don't have a name server. If you look up the
network to know what all systems are connected to the machine, you get
a bunch of IP addresses. You have a local cluster, printer, mobile
phones, laptops, IoT etc. 
</p>

<p>
Let us take the printer example. You are connected to 10 different
printers, each one is of a different type. And if you need to print a
file and you want to select a particular printer, and let's say you
don't the name of the printers but just the IP addresses. So what you
have to do is to look up a printer IP addresses table and take the
right printer's IP address. Still, you are limited to type it out or
copy-paste the IP address. To solve this, most of the private networks
append <a href="https://en.wikipedia.org/wiki/.local">.local</a> at the end of the machine's <a href="https://en.wikipedia.org/wiki/Hostname">hostname</a> using the <a href="https://en.wikipedia.org/wiki/Zero_configuration_networking">zeroconf</a>
technique. Now in the printer's example, if you look up the network
for the connected printers, you get
</p>
<div class="org-src-container">
<pre class="src src-text">1) my-epson-printer.local
2) my-canon-printer.local
3) my-hp-printer.local
...
</pre>
</div>

<p>
Now you don't have to remember the IP address of the printer you
want. All you have to remember is a human-readable name. 
</p>

<p>
Same goes for the cluster too. You can reach your cluster at
<code>my-awesome-cluster.local</code>. Even better, you can access to a <code>node1</code>
at <code>node1.my-awesome-cluster.local</code> and <code>node4</code> at
<code>node4.my-awesome-cluster.local</code>. If say <code>node1</code> goes down and if the
cluster starts a new node with a different IP address to take up
<code>node1</code>'s position, the new node will be reachable at
<code>node1.my-awesome-cluster.local</code>. This is called <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a>.
</p>

<div id="outline-container-org315811b" class="outline-2">
<h2 id="org315811b">Why do we need a hostname resolver for local networks?</h2>
<div class="outline-text-2" id="text-org315811b">
<p>
Earlier you used to connect to the cluster using the IP address of the
cluster and it worked. Now when you tell your application to connect
to the cluster using the <code>.local</code>, it simply doesn't know how to
connect. The problem is that the application doesn't know how to
resolve the <code>.local</code> domain name to the cluster IP address. It lacks a
DNS server. And since the cluster is a local one, your DNS server
can't resolve it.
</p>

<p>
In the case of the cloud system, you would have set up a domain name
and you can reach the cluster using the domain name. And the external
DNS helps you to resolve the domain name to the cluster IP address.
</p>
</div>
</div>

<div id="outline-container-org1fc92c0" class="outline-2">
<h2 id="org1fc92c0">mDNS</h2>
<div class="outline-text-2" id="text-org1fc92c0">
<p>
To solve this problem we have <a href="https://en.wikipedia.org/wiki/Multicast_DNS">mDNS</a>. mDNS is a protocol that resolves
hostname to IP addresses within a small network that lacks the name
server. By default, mDNS exclusively resolves hostnames ending with
<code>.local</code>. But there will be a problem with the hosts that implement
<code>.local</code> doesn't support mDNS protocol and can be found via a
conventional unicast DNS sever. In those cases, necessary network
configuration should be changed.
</p>
</div>

<div id="outline-container-org097fbf4" class="outline-3">
<h3 id="org097fbf4">Example</h3>
<div class="outline-text-3" id="text-org097fbf4">
<p>
Lets try out an example.
</p>

<p>
<code>RedisLabs</code> has a Redis Enterprise docker <a href="https://hub.docker.com/r/redislabs/redis/">image</a> that does many
things<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> but what we want here is the
Enterprise cluster.
</p>
</div>

<div id="outline-container-orga22aa9f" class="outline-4">
<h4 id="orga22aa9f">Why Redis Enterprise docker image?</h4>
<div class="outline-text-4" id="text-orga22aa9f">
<p>
The reason why I have chosen Redis Enterprise docker image is that it
aligns well with the previous cluster example. With Redis Enterprise
container, we can create a redis database cluster. And the cluster
will have a domain name with <code>.local</code> (i.e.,
<code>my-awesome-cluster.local</code>) and each node in the cluster receives a
<code>FQDN</code> (i.e., <code>node1.my-awesome-cluster.local</code>).
</p>

<p>
To sum up the above paragraph, we get a cluster which has a
<code>&lt;my-cluster&gt;.local</code> address and nodes with
<code>&lt;my-node&gt;.&lt;my-cluster&gt;.local</code>.
</p>

<p>
Now let's start the example.
</p>

<p>
You can start the container as follows:
</p>
<div class="org-src-container">
<pre class="src src-bash">docker run -it --cap-add sys_resource -p 12000:12000 -p 8443:8443 -p 9443:9443 redislabs/redis
</pre>
</div>

<p>
Ports <code>8443</code> and <code>9443</code> should be exposed compulsorily for the
container to do all its magic for services.
</p>

<p>
In the logs, you can find out that the container starts a mDNS server.
</p>

<div class="org-src-container">
<pre class="src src-text">...more logs...
2020-05-30 05:10:03,048 INFO success: mdns_server entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
...more logs...
</pre>
</div>

<p>
The port <code>12000</code> we have exposed can be any free port. This is the
port where the database we create will be listening on. In the current
example, I'm creating just one node. But it can be many.
</p>

<p>
Once the container is up and running, you can navigate to
<code>localhost:8443</code>.
</p>

<p>
You don't have to edit anything and under "Cluster configuration" you
can give your cluster FQDN like this.
</p>


<figure id="org0bbbf1b">
<img src="img/mdns-redis-cluster-conf.png" alt="mdns-redis-cluster-conf.png">

</figure>

<p>
You can skip entering the certificates to which the container creates
the certificates with default options. And then you can set some
credentials the redis enterprise container requires you to. Once you
set the credentials your page will be refreshed and you'll again be
told to enter the credentials. Once you sign in, you are ready to
create a database.
</p>

<p>
You can select "Redis" as your database, and you'll be given a form to
enter the configuration of the database.
</p>

<p>
I'm giving the name as <code>node1</code> and most importantly, you must set the
port to <code>12000</code> since that's the only port that we have exposed. Click
on "show advanced options" and you can find the field "Endpoint port
number" where you can enter the port. Enter it as <code>12000</code> (since
that's the port I have exposed). Click "Activate" to create the
database. You'll then be redirected to your created DB's configuration
page.
</p>


<figure id="orgac41844">
<img src="img/mdns-redis-db-conf-page.png" alt="mdns-redis-db-conf-page.png">

</figure>

<p>
You can find the <code>.local</code> address and IP address of the DB in the
<code>Endpoint</code> field.
</p>

<p>
Let us now create our sample application that simply connects to
<code>node1</code> and pings the database.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #0000FF;">FROM</span> <span style="color: #6434A3;">python:3.8-buster</span>

<span style="color: #0000FF;">RUN</span> pip3 install redis

<span style="color: #0000FF;">CMD</span> [<span style="color: #008000;">"python3"</span>]
</pre>
</div>

<p>
We have taken the python <code>buster</code> image which is Debian 10 that has
the mdns packages which we will install later.
</p>

<p>
Let's build it the application.
</p>

<div class="org-src-container">
<pre class="src src-text">$ docker build -t py-mdns .
Sending build context to Docker daemon  3.072kB
Step 1/3 : FROM python:3.8-buster
3.8-buster: Pulling from library/python
376057ac6fa1: Pull complete 
5a63a0a859d8: Pull complete 
496548a8c952: Pull complete 
2adae3950d4d: Pull complete 
0ed5a9824906: Pull complete 
bb94ffe72389: Pull complete 
241ada007777: Pull complete 
be68aa7d1eeb: Pull complete 
820ffc2e28ca: Pull complete 
Digest: sha256:ebe8df5c3e2e10a7aab04f478226979e3b8754ee6cd30358379b393ef8b5321e
Status: Downloaded newer image for python:3.8-buster
 ---&gt; 659f826fabf4
Step 2/3 : RUN pip3 install redis
 ---&gt; Running in 1d31f5312e3e
Collecting redis
  Downloading redis-3.5.2-py2.py3-none-any.whl (71 kB)
Installing collected packages: redis
Successfully installed redis-3.5.2
Removing intermediate container 1d31f5312e3e
 ---&gt; c21a8bc34782
Step 3/3 : CMD ["python3"]
 ---&gt; Running in 711a17a97211
Removing intermediate container 711a17a97211
 ---&gt; 27b0d68b69fc
Successfully built 27b0d68b69fc
Successfully tagged py-mdns:latest
$ docker run --it py-mdns
</pre>
</div>

<p>
Now lets start the application as follows:
</p>
<div class="org-src-container">
<pre class="src src-bash">$ docker  run -it py-mdns
</pre>
</div>

<p>
Remember that the <code>.local</code> address of <code>node1</code> is
<code>redis-12000.mycluster.local</code>, IP address is <code>172.17.0.2</code> and the port
is <code>12000</code>.
</p>

<p>
Now lets try to ping the database using the <code>.local</code> address.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ docker  run -it py-mdns
Python 3.8.3 (default, May 16 2020, 07:08:28) 
[GCC 8.3.0] on linux
Type <span style="color: #008000;">"help"</span>, <span style="color: #008000;">"copyright"</span>, <span style="color: #008000;">"credits"</span> or <span style="color: #008000;">"license"</span> for more information.
&gt;&gt;&gt; import redis
&gt;&gt;&gt; redis.Redis(<span style="color: #BA36A5;">host</span>=<span style="color: #008000;">'redis-12000.mycluster.local'</span>, <span style="color: #BA36A5;">port</span>=12000).ping()
<span style="color: #006699;">Traceback</span> (most recent call last):
  File <span style="color: #008000;">"/usr/local/lib/python3.8/site-packages/redis/connection.py"</span>, line 550,<span style="color: #0000FF;"> in</span> connect
    sock = self._connect()
  File <span style="color: #008000;">"/usr/local/lib/python3.8/site-packages/redis/connection.py"</span>, line 575,<span style="color: #0000FF;"> in</span> _connect
    <span style="color: #0000FF;">for</span> res<span style="color: #0000FF;"> in</span> socket.getaddrinfo(self.host, self.port, self.socket_type,
  File <span style="color: #008000;">"/usr/local/lib/python3.8/socket.py"</span>, line 918,<span style="color: #0000FF;"> in</span> getaddrinfo
    <span style="color: #0000FF;">for</span> res<span style="color: #0000FF;"> in</span> _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno -2] Name or service not known

During handling of the above exception, another exception occurred:

<span style="color: #006699;">Traceback</span> (most recent call last):
  File <span style="color: #008000;">"&lt;stdin&gt;"</span>, line 1,<span style="color: #0000FF;"> in</span> &lt;module&gt;
  File <span style="color: #008000;">"/usr/local/lib/python3.8/site-packages/redis/client.py"</span>, line 1378,<span style="color: #0000FF;"> in</span> ping
    <span style="color: #0000FF;">return</span> self.execute_command(<span style="color: #008000;">'PING'</span>)
  File <span style="color: #008000;">"/usr/local/lib/python3.8/site-packages/redis/client.py"</span>, line 898,<span style="color: #0000FF;"> in</span> execute_command
    conn = self.connection or pool.get_connection(command_name, **options)
  File <span style="color: #008000;">"/usr/local/lib/python3.8/site-packages/redis/connection.py"</span>, line 1183,<span style="color: #0000FF;"> in</span> get_connection
    connection.connect()
  File <span style="color: #008000;">"/usr/local/lib/python3.8/site-packages/redis/connection.py"</span>, line 554,<span style="color: #0000FF;"> in</span> connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error -2 connecting to redis-12000.mycluster.local:12000. Name or service not known.
</pre>
</div>

<p>
What happened is that your application lacks an mDNS service discovery
such that it doesn't know whom to ask and how to resolve the <code>.local</code>
hostname to IP address.
</p>

<p>
Connecting using the IP address works.
</p>

<div class="org-src-container">
<pre class="src src-bash">&gt;&gt;&gt; redis.Redis(<span style="color: #BA36A5;">host</span>=<span style="color: #008000;">'172.17.0.2'</span>, <span style="color: #BA36A5;">port</span>=12000).ping()
True
</pre>
</div>

<p>
Now lets try to add mDNS.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org8a94ca8" class="outline-2">
<h2 id="org8a94ca8">Avahi</h2>
<div class="outline-text-2" id="text-org8a94ca8">
<p>
<a href="https://en.wikipedia.org/wiki/Avahi_(software)">Avahi</a> is a free zero-configuration implementation of the mDNS
protocol. Let's try to add it.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #0000FF;">RUN</span> set -ex <span style="color: #008000;">\</span>
 &amp;&amp; apt-get update &amp;&amp; apt-get install -y --no-install-recommends avahi-daemon libnss-mdns
</pre>
</div>

<p>
<code>libnss</code> by default can resolve up to two-label such that it can
resolve the IP address of <code>mycluster.local</code> but what we need is
three-label. Let's try to configure add that configuration too.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #0000FF;">RUN</span> set -ex <span style="color: #008000;">\</span>
 &amp;&amp; apt-get update &amp;&amp; apt-get install -y --no-install-recommends avahi-daemon libnss-mdns <span style="color: #008000;">\</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">allow hostnames with more labels to be resolved. so that we can</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">resolve node1.mycluster.local.</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">(https://github.com/lathiat/nss-mdns#etcmdnsallow)</span>
 &amp;&amp; <span style="color: #006FE0;">echo</span> <span style="color: #008000;">'*'</span> &gt; /etc/mdns.allow <span style="color: #008000;">\</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Configure NSSwitch to use the mdns4 plugin so mdns.allow is respected</span>
 &amp;&amp; sed -i <span style="color: #008000;">"s/hosts:.*/hosts:          files mdns4 dns/g"</span> /etc/nsswitch.conf
</pre>
</div>

<p>
Now, we have the configuration, we can start the <code>avahi-daemon</code> when
our container start using the <code>ENTRYPOINT</code> script. Here's the
entrypoint script.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>

<span style="color: #006FE0;">set</span> -e

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">start avahi's dependency</span>
service dbus start

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">start avahi</span>
service avahi-daemon start

<span style="color: #0000FF;">exec</span> <span style="color: #008000;">"$@"</span>

</pre>
</div>

<p>
This starts <a href="https://en.wikipedia.org/wiki/D-Bus">dbus</a> which is a dependency of <code>avahi-daemon</code>. Now this is
how the <code>Dockerfile</code> looks like.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #0000FF;">FROM</span> <span style="color: #6434A3;">python:3.8-buster</span>

<span style="color: #0000FF;">WORKDIR</span> /app

<span style="color: #0000FF;">COPY</span> entrypoint.sh /app/

<span style="color: #0000FF;">RUN</span> set -ex <span style="color: #008000;">\</span>
 &amp;&amp; apt-get update &amp;&amp; apt-get install -y --no-install-recommends avahi-daemon libnss-mdns <span style="color: #008000;">\</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">allow hostnames with more labels to be resolved. so that we can</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">resolve node1.mycluster.local.</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">(https://github.com/lathiat/nss-mdns#etcmdnsallow)</span>
 &amp;&amp; <span style="color: #006FE0;">echo</span> <span style="color: #008000;">'*'</span> &gt; /etc/mdns.allow <span style="color: #008000;">\</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Configure NSSwitch to use the mdns4 plugin so mdns.allow is respected</span>
 &amp;&amp; sed -i <span style="color: #008000;">"s/hosts:.*/hosts:          files mdns4 dns/g"</span> /etc/nsswitch.conf <span style="color: #008000;">\</span>
 &amp;&amp; pip3 install redis

<span style="color: #0000FF;">ENTRYPOINT</span> [<span style="color: #008000;">"bash"</span>, <span style="color: #008000;">"./entrypoint.sh"</span>]

<span style="color: #0000FF;">CMD</span> [<span style="color: #008000;">"python3"</span>]

</pre>
</div>

<p>
Let's try to build the image and run the container.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ docker  run -it py-mdns
[ ok ] Starting system message bus: dbus.
[ ok ] Starting Avahi mDNS/DNS-SD Daemon: avahi-daemon.
Python 3.8.3 (default, May 16 2020, 07:08:28) 
[GCC 8.3.0] on linux
Type <span style="color: #008000;">"help"</span>, <span style="color: #008000;">"copyright"</span>, <span style="color: #008000;">"credits"</span> or <span style="color: #008000;">"license"</span> for more information.
&gt;&gt;&gt; import redis
&gt;&gt;&gt; redis.Redis(<span style="color: #BA36A5;">host</span>=<span style="color: #008000;">'redis-12000.mycluster.local'</span>, <span style="color: #BA36A5;">port</span>=12000).ping()
True
</pre>
</div>

<p>
As you can see, the avahi-daemon is being started. And it successfully
resolves <code>redis-12000.mycluster.local</code>.
</p>
</div>
</div>

<div id="outline-container-org2286c41" class="outline-2">
<h2 id="org2286c41">Running the container as non-root user</h2>
<div class="outline-text-2" id="text-org2286c41">
<p>
Now let's talk about the
security.<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup> Many container
platforms accept only non-root containers, Ex: openshift. If you want
your application to be deployed at any container platform, you
can't. Let us try to run the container as a non-root user.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ docker  run -it --user 1001 py-mdns
mkdir: cannot create directory &#8216;/var/run/dbus&#8217;: Permission denied
</pre>
</div>

<p>
The user argument takes a user UUID. It says to run as any other user
rather than root. `1001` is not a special user. It might just be
whatever UUID that doesn't match an existing user in the image. You
can also put <code>USER</code> command inside the <code>Dockefile</code>.
</p>

<p>
It requires root permission to start the application. You can check
the same by connecting to the container.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ docker exec -it a701fb0d30e2 bash
root@a701fb0d30e2:/app# ps -aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.8  0.0  13340  8276 pts/0    Ss+  06:27   0:00 python3
message+      19  0.0  0.0   8552  2368 ?        Ss   06:27   0:00 /usr/bin/dbus-daemon --system
avahi         46  0.0  0.0   7868  2564 ?        S    06:27   0:00 avahi-daemon: running [a701fb0d30e2.local]
avahi         47  0.0  0.0   7868   296 ?        S    06:27   0:00 avahi-daemon: chroot helper
root          71  7.0  0.0   5748  3636 pts/1    Ss   06:27   0:00 bash
root          76  0.0  0.0   9388  3092 pts/1    R+   06:27   0:00 ps -aux
root@a701fb0d30e2:/app#
</pre>
</div>

<p>
The reason why the application can't start as a non-root user is that
<code>dbus</code>, <code>avahi</code>'s dependency, requires root permissions to start.
</p>

<p>
There's a way to run <code>avahi</code> without <code>dbus</code> by adding <code>enable-dbus=no</code>
to the <code>[server]</code> section of <a href="https://linux.die.net/man/5/avahi-daemon.conf">avahi-daemon.conf</a> file. The file exists
in <code>/etc/avahi/avahi-daemon.conf</code>.
</p>

<p>
<code>avahi</code> by default requires root permissions to start. We can bypass
that by providing <code>--no-drop-root</code>
flag.<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>  You can check out all the options
<a href="https://linux.die.net/man/8/avahi-daemon">here</a>. Let us remove <code>dbus</code>. Also, let's start the process manually
without using <code>service</code>.
</p>

<p>
<code>Dockerfile</code>:
</p>
<div class="org-src-container">
<pre class="src src-diff"><span style="color: #545454;">   # Dockerfile</span>
<span style="color: #545454;">   &amp;&amp; sed -i "s/hosts:.*/hosts:          files mdns4 dns/g" /etc/nsswitch.conf \</span>
<span style="background-color: #AAFFAA;">+</span><span style="color: #008000; background-color: #DDFFDD;">  &amp;&amp; printf "[server]\nenable-dbus=no\n" &gt;&gt; /etc/avahi/avahi-daemon.conf \</span>
   &amp;&amp; pip3 install redis
</pre>
</div>

<p>
<code>entrypoint.sh</code>:
</p>
<div class="org-src-container">
<pre class="src src-diff"><span style="color: #545454;">  # entrypoint.sh</span>
<span style="background-color: #FFBBBB;">-</span><span style="color: #A60000; background-color: #FFDDDD;"> # start avahi's dependency</span>
<span style="background-color: #FFBBBB;">-</span><span style="color: #A60000; background-color: #FFDDDD;"> service dbus start</span>

<span style="color: #545454;">  # start avahi</span>
<span style="background-color: #FFBBBB;">-</span><span style="color: #A60000; background-color: #FFDDDD;"> service avahi-daemon start</span>
<span style="background-color: #AAFFAA;">+</span><span style="color: #008000; background-color: #DDFFDD;"> avahi-daemon --daemonize --no-drop-root</span>

</pre>
</div>

<p>
Now with our configuration, let's try to run the container.
</p>

<div class="org-src-container">
<pre class="src src-text">$ docker  run -it --user 1001 py-mdns bash
Timeout reached while wating for return value
Could not receive return value from daemon process.
</pre>
</div>

<p>
And the container exits. We still can't run the container as
non-root. The actual problem is with the files and folders the
<code>avahi-daemon</code> is accessing. These files should have either <code>root</code> or
<code>avahi</code> permissions to access it.
</p>

<p>
The files are:
</p>
<div class="org-src-container">
<pre class="src src-text">/etc/avahi/avahi-daemon.conf
/var/run/avahi-daemon        
</pre>
</div>

<p>
Lets try to change the permissions of the files and folders.
</p>

<div class="org-src-container">
<pre class="src src-diff"><span style="color: #545454;">  # Dockerfile</span>
<span style="color: #545454;">  &amp;&amp; printf "[server]\nenable-dbus=no\n" &gt;&gt; /etc/avahi/avahi-daemon.conf \</span>
<span style="background-color: #AAFFAA;">+</span><span style="color: #008000; background-color: #DDFFDD;"> &amp;&amp; chmod 777 /etc/avahi/avahi-daemon.conf \</span>
<span style="background-color: #AAFFAA;">+</span><span style="color: #008000; background-color: #DDFFDD;"> &amp;&amp; mkdir -p /var/run/avahi-daemon \</span>
<span style="background-color: #AAFFAA;">+</span><span style="color: #008000; background-color: #DDFFDD;"> &amp;&amp; chown avahi:avahi /var/run/avahi-daemon \</span>
<span style="background-color: #AAFFAA;">+</span><span style="color: #008000; background-color: #DDFFDD;"> &amp;&amp; chmod 777 /var/run/avahi-daemon</span>
  &amp;&amp; pip3 install redis
</pre>
</div>

<p>
We change the permissions of the file <code>/etc/avahi-daemon.conf</code> so that
the <code>avahi</code> daemon can access the file. We also create
<code>/var/run/avahi-daemon</code> directory since the <code>avahi</code> daemon requires
it. We also change the permissions of them after creating. Lets also
add <code>USER</code> flag so by default it runs as the UUID specified.
</p>

<p>
<code>Dockerfile</code>:
</p>
<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #0000FF;">FROM</span> <span style="color: #6434A3;">python:3.8-buster</span>

<span style="color: #0000FF;">WORKDIR</span> /app

<span style="color: #0000FF;">COPY</span> entrypoint.sh /app/

<span style="color: #0000FF;">RUN</span> set -ex <span style="color: #008000;">\</span>
 &amp;&amp; apt-get update &amp;&amp; apt-get install -y --no-install-recommends avahi-daemon libnss-mdns <span style="color: #008000;">\</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">allow hostnames with more labels to be resolved. so that we can</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">resolve node1.mycluster.local.</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">(https://github.com/lathiat/nss-mdns#etcmdnsallow)</span>
 &amp;&amp; <span style="color: #006FE0;">echo</span> <span style="color: #008000;">'*'</span> &gt; /etc/mdns.allow <span style="color: #008000;">\</span>
 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Configure NSSwitch to use the mdns4 plugin so mdns.allow is respected</span>
 &amp;&amp; sed -i <span style="color: #008000;">"s/hosts:.*/hosts:          files mdns4 dns/g"</span> /etc/nsswitch.conf <span style="color: #008000;">\</span>
 &amp;&amp; <span style="color: #006FE0;">printf</span> <span style="color: #008000;">"[server]\nenable-dbus=no\n"</span> &gt;&gt; /etc/avahi/avahi-daemon.conf <span style="color: #008000;">\</span>
 &amp;&amp; chmod 777 /etc/avahi/avahi-daemon.conf <span style="color: #008000;">\</span>
 &amp;&amp; mkdir -p /var/run/avahi-daemon <span style="color: #008000;">\</span>
 &amp;&amp; chown avahi:avahi /var/run/avahi-daemon <span style="color: #008000;">\</span>
 &amp;&amp; chmod 777 /var/run/avahi-daemon <span style="color: #008000;">\</span>
 &amp;&amp; pip3 install redis

<span style="color: #0000FF;">USER</span> 1001

<span style="color: #0000FF;">ENTRYPOINT</span> [<span style="color: #008000;">"bash"</span>, <span style="color: #008000;">"./entrypoint.sh"</span>]

<span style="color: #0000FF;">CMD</span> [<span style="color: #008000;">"python3"</span>]

</pre>
</div>

<p>
<code>entrypoint.sh</code>:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>

<span style="color: #006FE0;">set</span> -e

avahi-daemon --daemonize --no-drop-root

<span style="color: #0000FF;">exec</span> <span style="color: #008000;">"$@"</span>

</pre>
</div>

<p>
Now lets start the container. Now we don't have to pass <code>--user</code> flag
since we have put <code>USER</code> command inside <code>Dockerfile</code>.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ docker  run -it --user 1001 py-mdns
Python 3.8.3 (default, May 16 2020, 07:08:28) 
[GCC 8.3.0] on linux
Type <span style="color: #008000;">"help"</span>, <span style="color: #008000;">"copyright"</span>, <span style="color: #008000;">"credits"</span> or <span style="color: #008000;">"license"</span> for more information.
&gt;&gt;&gt; import redis
&gt;&gt;&gt; redis.Redis(<span style="color: #BA36A5;">host</span>=<span style="color: #008000;">'redis-12000.mycluster.local'</span>, <span style="color: #BA36A5;">port</span>=12000).ping()
True

</pre>
</div>

<p>
We can also see that the container is running as non-root.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ docker exec -it c641eeb8559f bash
I have no name!@c641eeb8559f:/app$ ps -aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
1001           1  0.4  0.0  27248 16220 pts/0    Ss+  08:22   0:00 python3
1001           8  0.0  0.0   8012  2524 ?        S    08:22   0:00 avahi-daemon: running [c641eeb8559f.local]
1001          10 11.0  0.0   5748  3612 pts/1    Ss   08:23   0:00 bash
1001          15  0.0  0.0   9388  3072 pts/1    R+   08:23   0:00 ps -aux
</pre>
</div>

<p>
We have reached the end of the post. You can find the code samples in
this <a href="https://github.com/GnaneshKunal/avahi-docker-non-root">repository</a>.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara"><a href="https://hub.docker.com/r/redislabs/redis/">Redis Enterprise Software</a> is enterprise grade,
distributed, in-memory NoSQL database server, fully compatible with
open source Redis by Redis Labs.</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara"><a href="https://engineering.bitnami.com/articles/why-non-root-containers-are-important-for-security.html">Bitnami Engineering</a>: Why
non-root containers are important for security</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara"><code>avahi-daemon.conf</code> has many
configurations and we don't need it in our application, so I'm just
setting the <code>enable-dbus</code> to <code>no</code>.</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">

<hr></hr>
<div class="nav">
<ul>
<li><a href="index.html">Home</a></li>
<li><a href="about.html">About</a></li>
<li><a href="https://github.com/Gnaneshkunal">GitHub</a></li>
<li><a href="resume.pdf">Résumé</a></li>
<li><a href="key.pub">PGP</a></li>
</ul>
</div>
</div>
</body>
</html>
